### ðŸ§  PROJECT SNAPSHOT â€” *Greko VRM Engine *

---

## ðŸŽ¯ Core Goal

Render and animate **VRoid (VRM 1.0) characters** in **Panda3D** on **Linux** with a **low-end GPU (GT 710)**, using a **custom MToon shader**, while restoring **facial expressions (blendshapes / morph targets)**â€”specifically blinkingâ€”which are currently missing at runtime.

---

## ðŸ§© High-Level Architecture

* **Engine:** Panda3D (ShowBase, C++ backend)
* **Rendering:** Custom GLSL MToon shader (linear color space, manual lighting control)
* **Assets:** VRM 1.0 â†’ converted to GLB
* **Primary Loader:** `p3assimp` (C++ Assimp) for performance and stability
* **Platform Constraints:** Low VRAM, limited GPU features (GT 710)

---

## ðŸ“‚ Current Project Structure (Relevant)

```
engine/
 â”œâ”€ base_engine.py        â† Core loop, UI, lighting, entity system
 â”œâ”€ entity.py
 â””â”€ camera_controller.py

vrmmanager/
 â”œâ”€ vrm_handler.py        â† Character loader/orchestrator (Assimp-based)
 â”œâ”€ vrmFixer.py           â† GLB/VRM JSON patcher
 â”œâ”€ verifyVRM.py          â† Morph verification utilities
 â””â”€ behaviours/
    â””â”€ blinker.py         â† Intended blink logic (currently blocked)

assets/
 â”œâ”€ kisayo.vrm
 â”œâ”€ kisayo_fixed.glb      â† Main test asset (patched VRM)
 â””â”€ other VRoid models

shaders/
 â”œâ”€ mtoon.vert
 â””â”€ mtoon.frag
```

---

## ðŸš¨ The Core Problem â€” *â€œThe Invisible Faceâ€*

* The **model renders correctly** (geometry, materials, lighting all work).
* **Blendshapes (morph targets)** exist in the file but are **missing in Panda3D**.
* `GeomVertexData.get_slider_table()` returns **None** for all meshes.
* As a result, **no facial animation (blink, expressions)** is possible.

---

## âœ… Verified Facts (Hard Evidence)

1. **Morph targets ARE present in the file**

   * JSON-level inspection of `kisayo_fixed.glb` confirms:

     ```
     meshes[].primitives[].targets[]  â†’ EXISTS
     ```
2. **VRM export & vrmFixer.py do NOT delete morph data**

   * The fixer only removes:

     * `VRMC_springBone`
     * `VRMC_node_constraint`
   * No mesh, primitive, or target arrays are stripped.
3. **Problem appears only after loading via Panda3D + Assimp**

   * Raw GLB is correct
   * Runtime scene graph is missing morph sliders

---

## âš ï¸ The Smoking Gun (Assimp)

During load, the terminal reports repeatedly:

```
aiBone shall contain weights, but pointer to them is NULL
```

### Interpretation:

* VRoid facial bones often have **zero vertex weights** (they rely on morphs instead).
* **Assimp treats zero-weight bones as invalid**.
* Assimp performs a cleanup / pruning pass:

  * Deletes â€œunweightedâ€ facial bones
  * Collapses node hierarchy
  * **Drops the associated morph/SliderTable data**

This happens **before Panda3D ever sees the mesh**.

---

## ðŸ§ª What Has Been Tried (and Failed)

* PRC flags:

  * `assimp-optimize-graph false`
  * `assimp-collapse-nodes false`
  * `assimp-keep-nodes #t`
  * `-debone`, `-optimize-graph`, `-optimize-meshes`
* Disabling Python glTF loader to force C++ Assimp
* Traversing scene graph:

  * `GeomNodes` â†’ no SliderTable
  * `Character`, `AnimBundle` â†’ no facial channels
* LoaderOptions tweaks, animation skipping, node preservation

ðŸ‘‰ **None stop Assimp from stripping facial morphs.**

---

## ðŸ§  Final Conclusion

This is **not**:

* A VRoid export problem
* A VRM â†’ GLB conversion problem
* A shader problem

This **is**:

> An Assimp design limitation with VRM-style facial rigs.

---

## ðŸ›£ï¸ Chosen Direction â€” Hybrid Loader Architecture (Decision Made)

### Philosophy

Use each system **only where it works**.

### Split Strategy

* **Assimp Loader (C++ / p3assimp):**

  * Body
  * Clothes
  * Skeleton
  * Skinning
  * Physics-ready bones (future jiggle, including chest physics)

* **Custom Loader (Python / JSON + buffers):**

  * Face mesh
  * Hair mesh (if morph-driven)
  * Morph targets / blendshapes
  * Manual construction of `SliderTable`

### Why this works

* Morph data lives in:

  ```
  meshes[].primitives[].targets
  ```

  â†’ independent of bones
* Panda3D can accept manually-built SliderTables
* Facial animation becomes **loader-agnostic**
* Body physics (including boob jiggle via bones/spring bones later) remains intact

---

## ðŸ§  Key Insight

> **Blendshapes do NOT require bones to exist.**
> They only require:

* Base vertex data
* Delta positions from `targets[]`

Assimp deleting bones should *never* kill morphs â€” but it does â€” so we bypass it.

---

## ðŸ“Œ Next Concrete Step (Active Task)

* Create a new file:

  ```
  vrmmanager/face_loader.py
  ```
* Purpose:

  * Parse GLB JSON + buffers directly
  * Extract morph targets for Face mesh
  * Manually build Panda3D `SliderTable`
  * Parent face under Assimp-loaded head bone

This will **prove blinking works** and unblock all expression logic.

---

## ðŸ§  Mental State / Meta

* Project complexity is high but **architecture is now clear**
* No more random flag guessing
* No more loader superstition
* Direction is stable and intentional

---

**Status:**
ðŸŸ¡ Rendering stable
ðŸ”´ Facial animation blocked (by Assimp)
ðŸŸ¢ Solution path identified and underway
